<?php

namespace App\Helpers;

use DateTime;

class NepaliDateConverter {
    // Lookup table for days in each month of BS years (2000-2099)
    private static $bsDaysInMonth = [
        2000 => [30, 32, 31, 32, 31, 30, 30, 30, 29, 30, 29, 31],
        2001 => [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2002 => [31, 31, 32, 32, 31, 30, 30, 29, 30, 29, 30, 30],
        2003 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31],
        2004 => [30, 32, 31, 32, 31, 30, 30, 30, 29, 30, 29, 31],
        2005 => [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2006 => [31, 31, 32, 32, 31, 30, 30, 29, 30, 29, 30, 30],
        2007 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31],
        2008 => [31, 31, 31, 32, 31, 31, 29, 30, 30, 29, 29, 31],
        2009 => [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2010 => [31, 31, 32, 32, 31, 30, 30, 29, 30, 29, 30, 30],
        2011 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31],
        2012 => [31, 31, 31, 32, 31, 31, 29, 30, 30, 29, 30, 30],
        2013 => [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2014 => [31, 31, 32, 32, 31, 30, 30, 29, 30, 29, 30, 30],
        2015 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31],
        2016 => [31, 31, 31, 32, 31, 31, 29, 30, 30, 29, 30, 30],
        2017 => [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2018 => [31, 32, 31, 32, 31, 30, 30, 29, 30, 29, 30, 30],
        2019 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 30, 29, 31],
        2020 => [31, 31, 31, 32, 31, 31, 30, 29, 30, 29, 30, 30],
        2021 => [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2022 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 30],
        2023 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 30, 29, 31],
        2024 => [31, 31, 31, 32, 31, 31, 30, 29, 30, 29, 30, 30],
        2025 => [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2026 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31],
        2027 => [30, 32, 31, 32, 31, 30, 30, 30, 29, 30, 29, 31],
        2028 => [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2029 => [31, 31, 32, 31, 32, 30, 30, 29, 30, 29, 30, 30],
        2030 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31],
        2031 => [30, 32, 31, 32, 31, 30, 30, 30, 29, 30, 29, 31],
        2032 => [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2033 => [31, 31, 32, 32, 31, 30, 30, 29, 30, 29, 30, 30],
        2034 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31],
        2035 => [30, 32, 31, 32, 31, 31, 29, 30, 30, 29, 29, 31],
        2036 => [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2037 => [31, 31, 32, 32, 31, 30, 30, 29, 30, 29, 30, 30],
        2038 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31],
        2039 => [31, 31, 31, 32, 31, 31, 29, 30, 30, 29, 30, 30],
        2040 => [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2041 => [31, 31, 32, 32, 31, 30, 30, 29, 30, 29, 30, 30],
        2042 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31],
        2043 => [31, 31, 31, 32, 31, 31, 29, 30, 30, 29, 30, 30],
        2044 => [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2045 => [31, 32, 31, 32, 31, 30, 30, 29, 30, 29, 30, 30],
        2046 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31],
        2047 => [31, 31, 31, 32, 31, 31, 30, 29, 30, 29, 30, 30],
        2048 => [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2049 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 30],
        2050 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 30, 29, 31],
        2051 => [31, 31, 31, 32, 31, 31, 30, 29, 30, 29, 30, 30],
        2052 => [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2053 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 30],
        2054 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 30, 29, 31],
        2055 => [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2056 => [31, 31, 32, 31, 32, 30, 30, 29, 30, 29, 30, 30],
        2057 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31],
        2058 => [30, 32, 31, 32, 31, 30, 30, 30, 29, 30, 29, 31],
        2059 => [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2060 => [31, 31, 32, 32, 31, 30, 30, 29, 30, 29, 30, 30],
        2061 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31],
        2062 => [30, 32, 31, 32, 31, 31, 29, 30, 29, 30, 29, 31],
        2063 => [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2064 => [31, 31, 32, 32, 31, 30, 30, 29, 30, 29, 30, 30],
        2065 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31],
        2066 => [31, 31, 31, 32, 31, 31, 29, 30, 30, 29, 29, 31],
        2067 => [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2068 => [31, 31, 32, 32, 31, 30, 30, 29, 30, 29, 30, 30],
        2069 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31],
        2070 => [31, 31, 31, 32, 31, 31, 29, 30, 30, 29, 30, 30],
        2071 => [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2072 => [31, 32, 31, 32, 31, 30, 30, 29, 30, 29, 30, 30],
        2073 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31],
        2074 => [31, 31, 31, 32, 31, 31, 30, 29, 30, 29, 30, 30],
        2075 => [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2076 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 30],
        2077 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 30, 29, 31],
        2078 => [31, 31, 31, 32, 31, 31, 30, 29, 30, 29, 30, 30],
        2079 => [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2080 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 30],
        2081 => [31, 31, 32, 32, 31, 30, 30, 30, 29, 30, 30, 30],
        2082 => [30, 32, 31, 32, 31, 30, 30, 30, 29, 30, 30, 30],
        2083 => [31, 31, 32, 31, 31, 30, 30, 30, 29, 30, 30, 30],
        2084 => [31, 31, 32, 31, 31, 30, 30, 30, 29, 30, 30, 30],
        2085 => [31, 32, 31, 32, 30, 31, 30, 30, 29, 30, 30, 30],
        2086 => [30, 32, 31, 32, 31, 30, 30, 30, 29, 30, 30, 30],
        2087 => [31, 31, 32, 31, 31, 31, 30, 30, 29, 30, 30, 30],
        2088 => [30, 31, 32, 32, 30, 31, 30, 30, 29, 30, 30, 30],
        2089 => [30, 32, 31, 32, 31, 30, 30, 30, 29, 30, 30, 30],
        2090 => [30, 32, 31, 32, 31, 30, 30, 30, 29, 30, 30, 30],
        2091 => [31, 31, 32, 31, 31, 31, 30, 30, 29, 30, 30, 30],
        2092 => [30, 31, 32, 32, 31, 30, 30, 30, 29, 30, 30, 30],
        2093 => [30, 32, 31, 32, 31, 30, 30, 30, 29, 30, 30, 30],
        2094 => [31, 31, 32, 31, 31, 30, 30, 30, 29, 30, 30, 30],
        2095 => [31, 31, 32, 31, 31, 31, 30, 29, 30, 30, 30, 30],
        2096 => [30, 31, 32, 32, 31, 30, 30, 29, 30, 29, 30, 30],
        2097 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 30, 30, 30],
        2098 => [31, 31, 32, 31, 31, 31, 29, 30, 29, 30, 29, 31],
        2099 => [31, 31, 32, 31, 31, 31, 30, 29, 29, 30, 30, 30]
    ];

    // Reference dates
    private static $bsRefDate = ['year' => 2000, 'month' => 9, 'day' => 17];
    private static $adRefDate = ['year' => 1944, 'month' => 1, 'day' => 1];

    /**
     * Convert BS date to AD date
     * @param string|array $date BS date as string (YYYY-MM-DD) or array ['year' => Y, 'month' => M, 'day' => D]
     * @return string|null AD date in YYYY-MM-DD format or null if invalid
     */
    public static function bs_to_ad($date) {
        // Parse input
        if (is_string($date)) {
            $parts = explode('-', $date);
            if (count($parts) !== 3) return null;
            $date = [
                'year' => (int)$parts[0],
                'month' => (int)$parts[1],
                'day' => (int)$parts[2]
            ];
        } elseif (!is_array($date) || !isset($date['year'], $date['month'], $date['day'])) {
            return null;
        }

        // Validate BS date
        if ($date['year'] < 2000 || $date['year'] > 2099 || $date['month'] < 1 || $date['month'] > 12 || $date['day'] < 1 || $date['day'] > self::$bsDaysInMonth[$date['year']][$date['month'] - 1]) {
            return null;
        }

        // Calculate days from BS reference date to input date
        $days = 0;
        for ($year = self::$bsRefDate['year']; $year < $date['year']; $year++) {
            for ($month = 0; $month < 12; $month++) {
                $days += self::$bsDaysInMonth[$year][$month];
            }
        }
        for ($month = 1; $month < $date['month']; $month++) {
            $days += self::$bsDaysInMonth[$date['year']][$month - 1];
        }
        $days += $date['day'] - self::$bsRefDate['day'];

        // Add days to AD reference date
        $adDate = new DateTime(sprintf('%04d-%02d-%02d', self::$adRefDate['year'], self::$adRefDate['month'], self::$adRefDate['day']));
        $adDate->modify("+$days days");

        return sprintf('%04d-%02d-%02d', $adDate->format('Y'), $adDate->format('m'), $adDate->format('d'));
    }

    /**
     * Convert AD date to BS date
     * @param string|array $date AD date as string (YYYY-MM-DD) or array ['year' => Y, 'month' => M, 'day' => D]
     * @return string|null BS date in YYYY-MM-DD format or null if invalid
     */
    public static function ad_to_bs($date) {
        // Parse input
        if (is_string($date)) {
            $parts = explode('-', $date);
            if (count($parts) !== 3) return null;
            $date = [
                'year' => (int)$parts[0],
                'month' => (int)$parts[1],
                'day' => (int)$parts[2]
            ];
        } elseif (!is_array($date) || !isset($date['year'], $date['month'], $date['day'])) {
            return null;
        }

        // Validate AD date
        $daysInMonth = cal_days_in_month(CAL_GREGORIAN, $date['month'], $date['year']);
        if ($date['month'] < 1 || $date['month'] > 12 || $date['day'] < 1 || $date['day'] > $daysInMonth) {
            return null;
        }

        // Calculate days between AD reference date and input date
        $refDateTime = new DateTime(sprintf('%04d-%02d-%02d', self::$adRefDate['year'], self::$adRefDate['month'], self::$adRefDate['day']));
        $inputDateTime = new DateTime(sprintf('%04d-%02d-%02d', $date['year'], $date['month'], $date['day']));
        $interval = $refDateTime->diff($inputDateTime);
        $days = $interval->days * ($interval->invert ? -1 : 1);

        // Convert days to BS date
        $bsDate = self::$bsRefDate;
        if ($days >= 0) {
            while ($days > 0) {
                $daysInCurrentMonth = self::$bsDaysInMonth[$bsDate['year']][$bsDate['month'] - 1];
                if ($bsDate['day'] + $days <= $daysInCurrentMonth) {
                    $bsDate['day'] += $days;
                    $days = 0;
                } else {
                    $days -= ($daysInCurrentMonth - $bsDate['day'] + 1);
                    $bsDate['day'] = 1;
                    $bsDate['month']++;
                    if ($bsDate['month'] > 12) {
                        $bsDate['month'] = 1;
                        $bsDate['year']++;
                    }
                    if ($bsDate['year'] > 2099) return null; // Beyond supported range
                }
            }
        } else {
            $days = abs($days);
            while ($days > 0) {
                if ($bsDate['day'] > $days) {
                    $bsDate['day'] -= $days;
                    $days = 0;
                } else {
                    $days -= $bsDate['day'];
                    $bsDate['day'] = self::$bsDaysInMonth[$bsDate['year']][$bsDate['month'] - 1];
                    $bsDate['month']--;
                    if ($bsDate['month'] < 1) {
                        $bsDate['month'] = 12;
                        $bsDate['year']--;
                    }
                    if ($bsDate['year'] < 2000) return null; // Before supported range
                }
            }
        }

        return sprintf('%04d-%02d-%02d', $bsDate['year'], $bsDate['month'], $bsDate['day']);
    }
}

?>